# Changelog

All notable changes to OpenCastor are documented here.

The format follows [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project uses [CalVer](https://calver.org/) versioning: `YYYY.M.DD.PATCH`.

## [2026.2.20.12] - 2026-02-20 üîÑ Auto-Start Daemon + Offline Fallback

### Highlights
OpenCastor can now survive reboots and internet outages. A one-command install
puts the gateway in systemd so it auto-starts on boot and auto-restarts on
crashes. When the internet goes down, `OfflineFallbackManager` transparently
switches the brain to a locally-running model (Ollama, LlamaCpp, or MLX) and
notifies the user via their configured channel.

### Added
- **`castor daemon` CLI** ‚Äî manage the systemd auto-start service:
  - `castor daemon enable --config bob.rcan.yaml` ‚Äî install, enable, start
  - `castor daemon status` ‚Äî installed / enabled / running / PID / uptime
  - `castor daemon logs [--lines N]` ‚Äî stream journal output
  - `castor daemon restart` / `castor daemon disable`
- **`castor/daemon.py`** ‚Äî systemd service management module:
  - `generate_service_file()` ‚Äî produces a well-formed `.service` file with
    `After=network-online.target`, `Restart=on-failure`, `RestartSec=5s`,
    `MemoryMax=1G`, `StandardOutput=journal`
  - `enable_daemon()` / `disable_daemon()` ‚Äî write service file + systemctl
  - `daemon_status()` / `daemon_logs()` ‚Äî introspect running state
- **`castor/connectivity.py`** ‚Äî lightweight internet and provider probes:
  - `is_online(timeout)` ‚Äî TCP probe to 1.1.1.1 + 8.8.8.8 port 53; no HTTP deps
  - `check_provider_reachable(name)` ‚Äî per-provider hostname check (local
    providers always return True)
  - `ConnectivityMonitor` ‚Äî background thread polling every N seconds with
    `on_change(online: bool)` callback; safe to crash in callback
- **`castor/offline_fallback.py`** ‚Äî automatic provider switching:
  - `OfflineFallbackManager` ‚Äî monitors connectivity, swaps brain to fallback
    provider when offline, swaps back when restored
  - Notifies via configured channel on switch (e.g. WhatsApp)
  - `get_active_provider()` ‚Äî transparent API; callers need no change
- **`offline_fallback` RCAN config block**:
  ```yaml
  offline_fallback:
    enabled: true
    provider: ollama          # ollama | llamacpp | mlx
    model: llama3.2:3b
    check_interval_s: 30
    alert_channel: whatsapp   # optional notify-on-switch
  ```
- **`api.py` integration**: all `think()` call sites route through
  `offline_fallback.get_active_provider()` when manager is active
- **Tests**: `tests/test_daemon.py` (8 tests), `tests/test_connectivity.py`
  (10 tests) covering service file generation, status parsing, TCP probes,
  monitor change callbacks

### Changed
- `AppState` gains `offline_fallback` field
- `/command`, `/cap/chat`, `_handle_channel_message` all use
  `offline_fallback.get_active_provider()` when configured

## [2026.2.20.11] - 2026-02-20 üí¨ Messaging Prompt System

### Highlights
Introduces a canonical, surface-aware messaging pre-prompt that lives in all
OpenCastor releases. `BaseProvider.build_messaging_prompt()` is the single
source of truth for how robots communicate with humans via text or voice ‚Äî
across WhatsApp, terminal, dashboard, Discord, and future surfaces. All seven
providers now honour the `surface=` parameter and use the shared prompt when
operating in text-only (no camera) mode.

### Added
- **`BaseProvider.build_messaging_prompt()`** ‚Äî canonical conversational system
  prompt shared by all providers and all surfaces. Accepts:
  - `robot_name` ‚Äî from RCAN metadata
  - `surface` ‚Äî `"whatsapp"` | `"terminal"` | `"dashboard"` | `"voice"` |
    `"discord"` | `"slack"` | `"irc"` | `"signal"` | `"sms"`
  - `hardware` ‚Äî live subsystem status dict (motors, camera, speaker)
  - `capabilities` ‚Äî RCAN capability names gate command vocabulary
  - `sensor_snapshot` ‚Äî live telemetry (distance, battery, speed, heading)
  - `memory_context` ‚Äî episodic/semantic memory from the virtual filesystem
  - Front-loads natural-language ‚Üí JSON command mappings; response rules
    route commands to reply + action JSON, questions to plain English only
- **`surface=` parameter on `BaseProvider.think()`** ‚Äî all seven providers
  (Anthropic, HuggingFace, OpenAI, Ollama, Google, MLX, LlamaCpp) accept and
  thread `surface` through to the messaging prompt at call time
- **`_CHANNEL_SURFACE` routing table in `api.py`** ‚Äî `_handle_channel_message`
  resolves channel name ‚Üí surface automatically:
  - WhatsApp / Telegram / Signal / SMS ‚Üí `"whatsapp"`
  - Discord / Slack / dashboard ‚Üí `"dashboard"`
  - IRC / terminal ‚Üí `"terminal"`
  - Voice channel ‚Üí `"voice"`
- **Surface-aware call sites wired**:
  - `castor shell` (`do_look`, `do_think`) ‚Üí `surface="terminal"`
  - Streamlit dashboard chat ‚Üí `surface="dashboard"`
  - `castor/repl.py` `look()` ‚Üí `surface="terminal"`
  - Anthropic provider uses `build_messaging_prompt()` in text-only mode
    (keeps cached system blocks for vision/action path)

### Fixed
- `_capture_live_frame()` now checks `camera.is_available()` and sniffs 16
  bytes to reject null-padding (`b"\x00"*N`) returned on CSI capture failure;
  returns `b""` so vision inference is never called for text-only messages
- `HuggingFaceProvider.think()` guard: `if self.is_vision and image_bytes`
  (empty bytes are falsy ‚Äî routes to `_think_text` instead of `_think_vision`)
- WhatsApp group policy evaluated before self-chat guard so owner can message
  their own groups (`is_from_me=True` in group context no longer short-circuits)
- Channel YAML config now passed to `create_channel()` so `group_policy`,
  `self_chat_mode`, `allow_from` take effect from `bob.rcan.yaml`
- Telegram channel `NameError: 'Update' is not defined` when
  `python-telegram-bot` is not installed ‚Äî stub fallback types added
- neonize `err-client-outdated` (405): rebuilt `neonize-linux-arm64.so` from
  source with whatsmeow updated 2025-12-05 ‚Üí 2026-02-19
- All blank-frame call sites changed from `b"\x00"*1024` to `b""` (shell,
  dashboard, repl) so vision guard works correctly

## [2026.2.20.10] - 2026-02-19 üì° Channel messaging wired into main loop

### Highlights
Channels (WhatsApp, Telegram, etc.) are now fully integrated into the robot's
main loop. Incoming messages inject into the brain context; the next brain
thought is sent back as a reply. Also fixes blank-frame blocking when
`camera_required: false` so the robot stays responsive even without a live
camera feed.

### Added
- **Channel startup in `main.py` (¬ß6h)** ‚Äî parses `config["channels"]`, creates
  and starts all enabled channels in persistent daemon event loops (loop stays
  alive so `asyncio.run_coroutine_threadsafe` keeps working)
- **Brain‚Üíchannel reply loop** ‚Äî `_reply_queue` collects `(channel_obj, chat_id)`
  pairs from `on_message` callbacks; main loop drains the queue after each
  brain thought and fires `send_message()` in a background thread
- **`camera_required: false`** in RCAN camera config ‚Äî when set, blank/missing
  frames no longer trigger a reactive `wait` action; the brain runs in
  text/sensor-only mode (messaging still works without a camera)
- **`castor/tiered_brain.py`** ‚Äî `ReactiveLayer` reads `camera.camera_required`
  (default `true`); blank-frame rules are skipped when `false`
- **`bob.rcan.yaml` fixes** ‚Äî `camera.type: oakd` (was `csi`), `camera_required: false`,
  full WhatsApp block with `allow_from`, `self_chat_mode`, `ack_reaction`

### Fixed
- Robot was stuck in `blank_frame` wait loop when CSI camera fails at boot;
  now continues autonomously (messaging-only mode) if `camera_required: false`
- WhatsApp `allow_from`/`self_chat_mode` config was missing from `bob.rcan.yaml`
- `castor/channels/__init__.py` ‚Äî channels were never launched from `main.py`;
  they are now started with a persistent event loop per channel

## [2026.2.20.9] - 2026-02-19 üí¨ OpenClaw-style WhatsApp access control

### Highlights
The WhatsApp channel now works exactly like OpenClaw's messaging integration:
owner can message their own linked number, access is controlled by `allow_from`,
unknown senders get a pairing flow, and groups are policy-gated.

### Added
- **`dm_policy`** ‚Äî `allowlist` | `pairing` | `open` (default: `allowlist`)
- **`allow_from`** ‚Äî E.164 phone number allowlist; owner auto-added at connect time
- **`self_chat_mode: true`** ‚Äî owner can message their own linked WhatsApp number
  and the robot responds (was previously blocked by `IsFromMe` filter)
- **`group_policy`** ‚Äî `disabled` | `open` | `allowlist` (default: `disabled`)
- **`ack_reaction`** ‚Äî emoji reaction sent on receipt (e.g. `"üëÄ"`)
- **`_dispatch(coro)`** ‚Äî extracted helper for scheduling async coroutines from
  neonize's sync thread; makes unit testing clean (no asyncio in tests)
- **`approve_pairing(code)`** ‚Äî approve a pending pairing request by code
- **`list_pairing_requests()`** ‚Äî return all pending pairing codes
- **Owner auto-detected** ‚Äî `_owner_number` set from `client.get_me()` on connect;
  auto-appended to `allow_from` so the robot always responds to its owner
- **`bob.rcan.yaml` updated** ‚Äî `allow_from: ["+19169967105"]`, `self_chat_mode: true`,
  `ack_reaction: "üëÄ"`
- **25 new tests** covering all dm_policy modes, self-chat, group policy,
  pairing flow, ack reactions, owner auto-add

### How to chat with your robot via WhatsApp
1. Run: `castor run --config bob.rcan.yaml` (or `castor dashboard`)
2. Open WhatsApp on your phone
3. Tap your own name / "Saved Messages" (message yourself)
4. Type anything ‚Äî the robot reads it and replies

### Stats
- **2,233 tests** (2,222 passing, 11 skipped) | **55,499 LOC** | 8 providers

## [2026.2.20.8] - 2026-02-19 üìä Dashboard auto-start + live exchange stats bar

### Highlights
`castor dashboard` now starts the robot immediately on entry ‚Äî no separate
`castor run` needed. A Claude Code-style status bar at the bottom of every tmux
session shows live token counts, cached tokens, API call count, data volume,
current tick, and last action ‚Äî updated every 2 seconds from the running robot.

### Added
- **`castor/runtime_stats.py`** ‚Äî thread-safe singleton stats tracker:
  `record_api_call(tokens_in, tokens_out, tokens_cached, bytes_in, bytes_out, model)`,
  `record_tick(tick, action)`, `reset()`, `get_status_bar_string()`.
  Writes `~/.opencastor/runtime_stats.json` (structured) and
  `/tmp/opencastor_status_bar.txt` (compact one-liner) on every call.
- **Live tmux status bar** ‚Äî `launch_dashboard()` now sets `status-right` to
  `#(cat /tmp/opencastor_status_bar.txt)` with `status-interval 2`.
  Displays: `‚è± uptime ‚îÇ üß† model ‚îÇ ‚ÜìXtok ‚ÜëYtok ‚îÇ üíæ cached ‚îÇ üîÅ N calls ‚îÇ ‚Üï data ‚îÇ tick N ‚îÇ action`
- **`castor dashboard` starts robot immediately** ‚Äî `cmd_dashboard` now drives
  the tmux TUI directly (was Streamlit). Accepts `--config`, `--layout`,
  `--simulate`, `--kill`. Auto-detects `*.rcan.yaml` in cwd if `--config` omitted.
- **`_auto_detect_config()`** helper in `cli.py` ‚Äî used by both `castor dashboard`
  and `castor dashboard-tui`. Finds single `*.rcan.yaml` in cwd automatically.
- **Provider hooks** ‚Äî `anthropic_provider`, `huggingface_provider`,
  `google_provider` each call `record_api_call()` after every LLM response.
  Anthropic path records `cache_read_input_tokens` for the cache savings display.
- **Main loop hook** ‚Äî `castor/main.py` calls `record_tick()` each tick and
  `reset()` at startup for clean per-session stats.
- **Status pane expanded** ‚Äî `_run_status_loop()` now includes an Exchange Stats
  section with per-field breakdown (tokens in/out, cached, calls, data vol, tick, action).
- **34 new tests** (`tests/test_runtime_stats.py`): accumulation, reset,
  file persistence, formatting helpers, thread safety.

### Changed
- `castor dashboard` argparser now accepts `--config`, `--layout`, `--simulate`,
  `--kill` (was a no-arg Streamlit launcher).
- tmux status bar style: dark grey background, green active pane border,
  pane titles visible at top of each pane.

### Stats
- **2,207 tests** (2,196 passing, 11 skipped) | **55,006 LOC** | 8 providers

## [2026.2.20.7] - 2026-02-19 üîß Installer PATH fix

### Fixed
- **Installer auto-adds `castor` to PATH** ‚Äî `scripts/install.sh` now writes
  `export PATH="~/opencastor/venv/bin:$PATH"` to the correct shell profile
  (`~/.bashrc` for bash, `~/.zshrc`/`~/.zprofile` for zsh, `config.fish` for fish).
  Idempotent ‚Äî won't duplicate on reinstall. Also `export`s immediately so `castor`
  works in the same terminal session without needing `source venv/bin/activate`.
  Success banner updated: no longer shows the manual activate step.
- **Uninstaller cleans up PATH entry** ‚Äî `scripts/uninstall.sh` now strips the
  opencastor PATH line from all shell profiles on removal.
- **`scripts/sync-version.py`** ‚Äî now also patches `scripts/install.sh` VERSION
  variable so the installer always ships the correct version string.
- **`install.sh VERSION`** ‚Äî was frozen at `2026.2.20.0`; now correctly tracks
  the current release via sync-version.py.

### Stats
- **2,173 tests** (2,162 passing, 11 skipped) | **55,006 LOC** | 8 providers

## [2026.2.20.6] - 2026-02-19 üß† Brand ¬∑ Vision ¬∑ Peripherals ¬∑ Prompt Cache

### Highlights
New brain+neural identity, Gemini 3 Flash agentic vision, universal plug-and-play
peripheral detection (`castor scan`), prompt-cache-first Anthropic architecture, and
a hardware-wins boot sequence that gets the robot moving even when the config file
lags behind reality.

### Added
- **New brand identity** ‚Äî brain+neural+connector icon design replaces old C-shape robot.
  `site/assets/logo.svg`, `logo-white.svg`, `icon.svg`, `icon-dark.svg`, `favicon.svg`.
  `brand/` directory with 4 canonical variants:
  `neural-gradient/`, `flat-solid/`, `geometric/`, `badge/` + `VARIANTS.md` spec.
  Full PNG export set (16√ó16 ‚Üí 512√ó512) via `rsvg-convert`. All nav/footer logos updated
  across `index.html`, `hub.html`, `docs.html`.
- **Gemini 3 Flash Agentic Vision** (`castor/providers/google_provider.py`) ‚Äî
  `_AGENTIC_VISION_MODELS` set; `code_execution` tool auto-enabled for `gemini-3-flash-preview`;
  system prompt addendum injected. Opt-in/opt-out via `agentic_vision:` RCAN key.
  5 new tests.
- **Plug-and-play peripheral auto-detection** (`castor/peripherals.py`) ‚Äî
  30+ USB VID:PIDs, 18 I2C addresses, V4L2/CSI/NPU/serial scanning.
  `castor scan` CLI prints detected hardware + RCAN config snippets.
  `castor doctor` ‚Äî peripheral health section appended.
  `docs/peripherals.md` ‚Äî 740-line guide for all supported hardware classes.
  16 new tests.
- **Prompt cache-first architecture** (`castor/prompt_cache.py`) ‚Äî
  `CacheStats` dataclass, `build_cached_system_prompt()` (static robot identity + safety rules),
  `build_sensor_reminder()` delivers per-tick sensor state as `<castor-state>` XML in user
  messages (never system prompt). `anthropic_provider.py` updated with `cache_control`
  breakpoints and `extra_headers: anthropic-beta: prompt-caching-2024-07-31`.
  Cache hit-rate alert surfaced in `castor doctor` (warns below 50% after 10-call warmup).
  RCAN schema: `prompt_caching: bool`, `cache_alert_threshold: float`.
  28 new tests.
- **Hardware-detection-wins boot sequence** (`castor/main.py`) ‚Äî
  `_load_env_file()`: reads `~/.opencastor/env` on every boot, loads `HF_TOKEN`,
  `GOOGLE_API_KEY`, etc. into `os.environ` before any provider init (shell exports win).
  `apply_hardware_overrides(config)`: real hardware detected at boot ALWAYS overrides
  RCAN config. Camera priority: `oakd ‚Üí realsense ‚Üí usb ‚Üí csi`. PCA9685: scans 0x40‚Äì0x47
  for actual address if configured one is absent. Logs `‚ö° Hardware override` warnings with
  update hints. Validated on Pi: OAK-D online, Qwen firing at 700‚Äì930 ms, real move/stop
  decisions from live frames.
- **Website reframe** ‚Äî OG description, hero sub-headline, and feature cards now emphasize
  universal plug-and-play; OAK-D/Hailo-8 are examples, not requirements.

### Fixed
- Camera config: `camera.type: "auto"` now tries `oakd ‚Üí realsense ‚Üí usb ‚Üí csi ‚Üí none`
  preventing blank-frame loops when the configured camera isn't present at boot.

### Stats
- **2,173 tests** (2,162 passing, 11 skipped) | **55,006 LOC** | 8 providers

## [2026.2.20.5] - 2026-02-20 üéÆ Demo ¬∑ Validate ¬∑ Community

### Highlights
Three new pillars: a 5-act live demo showing the full agent stack, a `castor validate`
conformance checker that scores your robot config, and a proper community hub with recipes,
contributing guide, and GitHub discoverability.

### Added
- **`castor demo` overhaul** ‚Äî 5-act pipeline show: ObserverAgent + NavigatorAgent process
  real simulated Hailo detections, reactive E-STOP fires on obstacles, TaskPlanner dispatches
  grasp to ManipulatorSpecialist, Sisyphus mock improvement loop. No hardware needed.
  `--layout minimal` for quick preview, `--no-color` for CI.
- **`castor validate`** ‚Äî RCAN conformance checker (`castor/conformance.py`):
  20 behavioral invariant checks across Safety, Provider, Protocol, Performance, Hardware.
  Scored 0-100. `--json` for CI integration, `--strict` for hard failures on warnings.
- **Community Hub** (`site/hub.html`) ‚Äî featured recipe cards, Get Involved section,
  social links, community stats bar
- **`CONTRIBUTING.md`** ‚Äî contribution guide: recipes, bugs, providers, tests, docs
- **`docs/community-recipes.md`** ‚Äî 400-line recipe authoring guide
- **`docs/community/reddit-launch-post.md`** ‚Äî r/robotics launch post draft
- **GitHub topics** ‚Äî 10 topics set for discoverability
- **`castor doctor`** ‚Äî now hints `castor validate` for deep config checks
- **115 new tests** (110 conformance + 5 demo)

### Stats
- **2,124 tests** passing (11 skipped) | **52,314 LOC** | 8 providers

## [2026.2.20.4] - 2026-02-20 üîå Agent Runtime Wiring + Dashboard

### Highlights
Agents are now live ‚Äî the robot spawns ObserverAgent and NavigatorAgent at startup,
feeds them real sensor data, blends their output into the tiered brain, and shuts them
down gracefully. Sisyphus patches broadcast to the fleet automatically. The TUI shows
everything in real-time.

### Added
- **Agent roster runtime integration** (`castor/main.py`):
  - Reads `agent_roster` config at startup, spawns agents with shared `SharedState`
  - ObserverAgent fed Hailo detections + depth data every tick
  - NavigatorAgent suggestion (`nav_direction`, `nav_speed`) blended into tiered brain
  - Graceful `stop_all()` on shutdown
- **Sisyphus ‚Üí PatchSync hookup** (`castor/learner/apply_stage.py`):
  - `set_swarm_config()` injects swarm credentials
  - `_broadcast_to_swarm()` publishes every applied patch to fleet SharedMemory
  - Auto-injected from main.py when swarm is enabled
- **Dashboard TUI overhaul** (`castor/dashboard_tui.py`):
  - Agents panel ‚Äî live status from `~/.opencastor/agent_status.json`
  - Swarm panel ‚Äî fleet peers + synced patches from `swarm_memory.json`
  - Improvements panel ‚Äî last 5 Sisyphus patches with ‚úÖ/‚ùå icons
  - Episode counter ‚Äî live count from `~/.opencastor/episodes/`
- **`AgentRegistry.write_status_file()`** ‚Äî runtime writes agent health for TUI
- **`bob.rcan.yaml`** ‚Äî Pi config updated with `agent_roster` + `swarm` sections
- **27 new integration tests**

### Stats
- **1,998 tests** passing (11 skipped) | **49,267 LOC** | 8 providers

## [2026.2.20.3] - 2026-02-20 ü§ñ Agent Swarm Architecture (Phase 2-4)

### Highlights
Three new layers of intelligence: Observer + Navigator (Phase 2),
Task Specialists + TaskPlanner (Phase 3), and Multi-Robot Swarm Coordination (Phase 4).

### Added
- **Phase 2 ‚Äî Observer + Navigator** (`castor/agents/`):
  - `BaseAgent` ABC ‚Äî lifecycle (start/stop), observe/act interface, health reporting
  - `ObserverAgent` ‚Äî converts Hailo-8/depth sensor data into structured `SceneGraph`
  - `NavigatorAgent` ‚Äî potential-field path planning; publishes RCAN-compatible action dicts
  - `SharedState` ‚Äî thread-safe pub/sub state bus for inter-agent communication
  - `AgentRegistry` ‚Äî spawn, list, stop, health-check agents by name
- **Phase 3 ‚Äî Task Specialists** (`castor/specialists/`):
  - `ManipulatorSpecialist` ‚Äî 6-DOF arm/gripper planning (grasp, place, home)
  - `ScoutSpecialist` ‚Äî frontier-based autonomous exploration, 20√ó20 occupancy grid
  - `DockSpecialist` ‚Äî smooth deceleration dock approach, battery threshold checks
  - `ResponderSpecialist` ‚Äî human-readable status formatting, alert severity
  - `TaskPlanner` ‚Äî heapq priority queue, capability matching, concurrent execution
- **Phase 4 ‚Äî Swarm Coordination** (`castor/swarm/`):
  - `SwarmPeer` ‚Äî represents a discovered fleet peer with load scoring
  - `SwarmCoordinator` ‚Äî capability-matched, load-balanced task dispatch
  - `SharedMemory` ‚Äî cross-robot knowledge store with TTL, JSON persistence, merge
  - `SwarmConsensus` ‚Äî optimistic task claiming, TTL-based locks, leader election
  - `PatchSync` ‚Äî broadcast Sisyphus improvement patches fleet-wide
- **`castor agents` CLI** ‚Äî list, status, spawn, stop agents
- **RCAN schema** ‚Äî `agent_roster` and `swarm` config sections
- **468 new tests** (168 Phase 2 + 185 Phase 3 + 115 Phase 4)

### Stats
- **1,912 tests** passing (11 skipped) | **~42,000 LOC** | 8 providers

---

## [2026.2.20.2] - 2026-02-20 üìã RCAN Schema + WhatsApp Pairing Fix

### Fixed
- **RCAN schema updated** ‚Äî Added `tiered_brain`, `reactive`, `learner` sections. Added all 8 provider aliases to `agent.provider` enum (huggingface, llamacpp, mlx, claude_oauth, etc.). Added `depth_enabled` and `base_url` fields.
- **WhatsApp pairing** ‚Äî Rewrote wizard pairing to use `Popen` for real-time QR output, added `QREvent` handler, 3-minute timeout, explicit session persistence on connect, and better error messaging.
- **RCAN validator** ‚Äî Skip `community-recipes/` (partial configs by design, not full RCAN).

---

## [2026.2.20.1] - 2026-02-20 üéõÔ∏è Improve CLI Shortcuts

### Added
- **`castor improve --enable`** ‚Äî Enable self-improving loop from CLI with sensible defaults (HF free tier, every 5 episodes, config auto-apply only)
- **`castor improve --disable`** ‚Äî Pause self-improving loop, preserves config and history
- Auto-detects RCAN config when single `*.rcan.yaml` in cwd
- Preserves existing learner settings when re-enabling (won't overwrite provider/model)
- 7 new tests for enable/disable toggle (`test_improve_toggle.py`)

### Stats
- **1,444 tests** passing (11 skipped) | **40,287 LOC** | 8 providers

---

## [2026.2.20.0] - 2026-02-20 üß† Self-Improving Loop

### Highlights
The robot learns from its mistakes. The **Sisyphus Loop** analyzes episodes,
identifies failures, generates fixes, verifies them, and applies improvements
automatically. Inspired by Oh-My-OpenCode's PM‚ÜíDev‚ÜíQA/QC pattern.

### Added
- **Self-Improving Loop** (`castor/learner/` package ‚Äî 10 modules):
  - `episode.py` ‚Äî Episode data model with full serialization
  - `episode_store.py` ‚Äî JSON file persistence with retention policy
  - `pm_stage.py` ‚Äî Analyzes episodes, identifies failures and root causes
  - `dev_stage.py` ‚Äî Generates config/behavior/prompt patches from analysis
  - `qa_stage.py` ‚Äî Safety bounds verification, consistency checks
  - `apply_stage.py` ‚Äî Applies verified patches with rollback support
  - `sisyphus.py` ‚Äî Orchestrates PM‚ÜíDev‚ÜíQA‚ÜíApply with retry (up to 3x)
  - `alma.py` ‚Äî Cross-episode pattern analysis (ALMA consolidation)
  - `patches.py` ‚Äî ConfigPatch, BehaviorPatch, PromptPatch types
- **`castor improve` CLI** ‚Äî analyze episodes, view history, rollback patches
- **Wizard Step 7: Self-Improving Loop** ‚Äî opt-in setup with 4 cost presets:
  - Free ($0): Ollama local analysis
  - Budget ($0): HuggingFace free API
  - Smart (~$1-3/mo): Gemini Flash-Lite
  - Premium (~$5-15/mo): Claude Sonnet
- **Episode recording** in main control loop (saved on shutdown)
- **Auto-apply preferences**: config-only, config+behavior, or manual review
- 107 new tests (1437 total)

### Changed
- Learner is **disabled by default** ‚Äî users must opt-in via wizard or YAML
- Wizard now has 8 steps (added self-improving loop setup)

### Design
```
Episode ‚Üí PM (Analyze) ‚Üí Dev (Patch) ‚Üí QA (Verify) ‚Üí Apply (if pass)
                                              ‚Üì
                                        Retry (up to 3x)
                                              ‚Üì
                                     Human review queue
```

## [2026.2.19.1] - 2026-02-19

### Added
- **MLX Provider** (`castor/providers/mlx_provider.py`): Apple Silicon native
  inference via mlx-lm (direct) or vLLM-MLX/MLX-OpenAI-Server (OpenAI API).
  400+ tok/s on M4 Max. Vision support via mlx-vlm. Provider aliases:
  `mlx`, `mlx-lm`, `vllm-mlx`.
- MLX models in wizard: Qwen2.5-VL-7B, Llama 3.3 8B, Mistral Small 3.1 24B
- llama.cpp and MLX providers added to wizard provider selection
- 8 new provider tests (1330 total)

### Changed
- Provider count: 7 ‚Üí 8 (Anthropic, Google, OpenAI, HuggingFace, Ollama,
  llama.cpp, MLX, Claude OAuth)

## [2026.2.19.0] - 2026-02-19 üöÄ Major Release

### Highlights
OpenCastor v2026.2.19.0 is a landmark release that transforms the framework into a
production-ready, cost-effective AI robotics runtime. **8 AI providers**, a **tiered
brain architecture** that starts at $0/month, **Hailo-8 NPU vision**, **OAK-D depth
camera** support, and an interactive wizard that guides users through optimal setup.

### Added
- **Tiered Brain Architecture** (`castor/tiered_brain.py`): Three-layer system ‚Äî
  Reactive (<1ms rules), Fast Brain (~500ms HF/Gemini), Planner (~12s Claude).
  Configurable planner interval, uncertainty escalation, per-layer stats.
- **Hailo-8 NPU Vision** (`castor/hailo_vision.py`): YOLOv8s object detection at
  ~250ms on Hailo-8. 80 COCO classes, obstacle classification, clear-path analysis.
  Zero API cost for reactive obstacle avoidance.
- **OAK-D Stereo Depth Camera**: RGB + depth streaming via DepthAI v3 API.
  Depth-based obstacle distance (5th percentile center region). Camera type `oakd`
  with `depth_enabled: true` in config.
- **llama.cpp Provider** (`castor/providers/llamacpp_provider.py`): Local LLM
  inference via Ollama OpenAI API or direct GGUF loading. Model pre-loading with
  keep-alive. Provider aliases: `llamacpp`, `llama.cpp`, `llama-cpp`.
- **HuggingFace Vision Models**: Added Qwen2.5-VL-7B/3B, Llama-4-Scout/Maverick
  to vision model registry. Free Inference API = $0 robot brain.
- **Brain Architecture Wizard**: New Step 6 in wizard ‚Äî 5 cost-tier presets from
  Free ($0) to Maximum Intelligence. Auto-detects Hailo-8 NPU. Shows estimated
  monthly cost. Explains the tiered approach to new users.
- **Graceful Shutdown**: SIGTERM/SIGINT handler with phased cleanup ‚Äî motors ‚Üí
  watchdog ‚Üí battery ‚Üí hardware ‚Üí speaker ‚Üí camera ‚Üí filesystem ‚Üí audit.
- **Claude OAuth Proxy** (`castor/claude_proxy.py`): Native `ClaudeOAuthClient`
  wraps `claude -p` CLI for setup-token auth without per-token billing.
- 16 new tests (1319 total across Python 3.10-3.12)

### Changed
- Primary brain defaults to open-source model (Qwen2.5-VL via HuggingFace)
- Tiered brain wiring: primary config = fast brain, secondary[0] = planner
- Camera class supports three modes: OAK-D, CSI (picamera2), USB (OpenCV)
- Watchdog timeout increased to 30s for Claude CLI latency on ARM
- Hailo vision defaults to opt-in (`hailo_vision: false`) to avoid CI segfaults
- Doctor test patched for env file leak from credential store

### Fixed
- Anthropic provider auto-routes OAuth tokens through Claude CLI
- OpenAI provider supports `base_url` for custom endpoints (Ollama, etc.)
- Installer version synced to release version

### Architecture
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Layer 0: Reactive (<1ms)                           ‚îÇ
‚îÇ  ‚îú‚îÄ Blank frame ‚Üí wait                              ‚îÇ
‚îÇ  ‚îú‚îÄ Depth obstacle < 0.3m ‚Üí stop                    ‚îÇ
‚îÇ  ‚îú‚îÄ Battery critical ‚Üí stop                         ‚îÇ
‚îÇ  ‚îî‚îÄ Hailo-8 YOLOv8 (~250ms) ‚Üí avoid/stop          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 1: Fast Brain (~500ms)                       ‚îÇ
‚îÇ  ‚îî‚îÄ Qwen2.5-VL / Gemini Flash / Ollama             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Layer 2: Planner (~10-15s, every N ticks)          ‚îÇ
‚îÇ  ‚îî‚îÄ Claude Sonnet / Opus                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Providers (8 total)
| Provider | Models | Auth |
|----------|--------|------|
| Anthropic | Claude 4 family | API key or setup-token (OAuth) |
| Google | Gemini 2.5 Flash/Pro | API key |
| OpenAI | GPT-4o, o1 | API key |
| HuggingFace | Qwen-VL, Llama 4, any Hub model | HF token (free) |
| Ollama | Any GGUF model | Local (no auth) |
| llama.cpp | Direct GGUF or Ollama API | Local (no auth) |
| MLX | Apple Silicon native (mlx-lm, vLLM-MLX) | Local (no auth) |
| Claude OAuth | Max/Pro subscription | setup-token |

## [2026.2.18.13] - 2026-02-18

### Added
- **Tiered Brain Architecture** (`castor/tiered_brain.py`) ‚Äî three-layer brain pipeline:
  - Layer 0 (Reactive): Rule-based safety (<1ms) ‚Äî obstacle stop, blank frame wait, battery critical
  - Layer 1 (Fast Brain): Primary perception-action loop (Gemini Flash / Ollama, ~1-2s)
  - Layer 2 (Planner): Complex reasoning (Claude, ~10-15s) ‚Äî periodic or on escalation
- **Graceful shutdown** ‚Äî SIGTERM/SIGINT caught with phased cleanup: motors ‚Üí services ‚Üí hardware ‚Üí filesystem
- **Ollama installed on Pi** ‚Äî gemma3:1b available (CPU-only, ~15s ‚Äî Gemini Flash recommended for fast brain)
- 17 new tests (1303 total)

## [2026.2.18.12] - 2026-02-18

### Added
- **Claude OAuth client** (`castor/claude_proxy.py`) ‚Äî native integration with Claude Max/Pro subscriptions via OAuth token. Works like OpenClaw: `castor login anthropic` generates a setup-token, the brain routes through Claude CLI with proper model selection and system prompts. No per-token billing.
- **OpenAI provider `base_url` support** ‚Äî point at any OpenAI-compatible endpoint

### Fixed
- Anthropic provider auto-detects OAuth tokens and routes correctly (no more 401 errors with setup-tokens)

## [2026.2.18.11] - 2026-02-18

### Added
- **Terminal Dashboard** (`castor dashboard-tui`) ‚Äî tmux-based multi-pane robot monitor. Watch your robot's brain, eyes, body, safety, and messaging subsystems in real-time across split panes. Three layouts: `full` (6 panes), `minimal` (3), `debug` (4). Mouse-enabled, zoom with Ctrl+B z.
- **tmux added to installer** ‚Äî auto-installed as a system dependency on Linux

## [2026.2.18.10] - 2026-02-18

### Added
- **WhatsApp setup flow** ‚Äî wizard now verifies neonize is installed (auto-installs if missing), checks for existing session, explains QR pairing flow, and optionally starts a live QR pairing session right from the wizard
- **Telegram bot verification** ‚Äî wizard collects bot token and verifies it by calling Telegram's `getMe` API, showing bot name and username on success
- **Generic channel setup** ‚Äî all channels now get proper credential collection and validation

## [2026.2.18.9] - 2026-02-18

### Changed
- **Credentials moved to `~/.opencastor/`** ‚Äî `.env` vars now written to `~/.opencastor/env` (0600 perms) alongside `anthropic-token` and `wizard-state.yaml`. Local `.env` still written for backward compat.
- **Uninstaller redesigned** ‚Äî removes install dir but keeps `~/.opencastor/` by default. Asks user: "[1] Keep credentials (recommended)" or "[2] Delete everything". Migrates legacy `.env` to `~/.opencastor/env` during uninstall.
- **Auth loads `~/.opencastor/env` first** ‚Äî `load_dotenv_if_available()` reads the safe env file before local `.env`, without overriding already-set vars.

## [2026.2.18.8] - 2026-02-18

### Added
- **AI accelerator detection** ‚Äî health check now detects Hailo AI Hat (PCIe + /dev/hailo*), Google Coral TPU, Intel Movidius/MyriadX (OAK-D), and Nvidia Jetson
- **Auth module knows about token store** ‚Äî `check_provider_ready("anthropic")` now checks `~/.opencastor/anthropic-token`, fixing the "no key set" false positive in post-wizard health check

### Fixed
- Post-wizard health check no longer says "FAIL: Provider key (anthropic) no key set" when setup-token is stored
- Removed stale `ANTHROPIC_AUTH_MODE=oauth` check from auth module

## [2026.2.18.7] - 2026-02-18

### Fixed
- **Installer version synced** ‚Äî `install.sh` and `install.ps1` now show correct version (were stuck at v2026.2.17.20)

## [2026.2.18.6] - 2026-02-18

### Added
- **Deep hardware discovery** ‚Äî startup health check now enumerates:
  - USB devices (via `lsusb`) ‚Äî shows what's connected at each port
  - I2C devices (via `i2cdetect`) ‚Äî identifies PCA9685, IMUs, sensors, OLEDs by address
  - SPI bus availability
  - Serial ports (UART, USB-serial adapters like Arduino/ESP32)
  - Loaded kernel drivers (I2C, SPI, PWM, V4L2, USB-serial, audio)

### Changed
- **Anthropic model fetch no longer uses API** ‚Äî setup-tokens return 401 on `/v1/models`. Now parses model IDs from the public docs page (no auth needed). Falls back to static list if docs unreachable.

## [2026.2.18.5] - 2026-02-18

### Fixed
- **Token priority fix** ‚Äî OpenCastor stored token (`~/.opencastor/anthropic-token`) now takes priority over `ANTHROPIC_API_KEY` env var and `.env` file. Prevents using OpenClaw's stale API key instead of the setup-token you just saved.
- **Stop importing OpenClaw's Anthropic key** ‚Äî wizard no longer auto-detects `ANTHROPIC_API_KEY` from OpenClaw config (other provider keys like Google/OpenAI are still imported). This prevents the token sink problem.
- **Wizard detects existing setup-token** ‚Äî on re-run, if `~/.opencastor/anthropic-token` exists, offers to reuse it instead of asking for a new one.
- **Health check shows correct auth source** ‚Äî now reports "setup-token stored" when using token store, not "ANTHROPIC_API_KEY set" from the wrong source.

## [2026.2.18.4] - 2026-02-18

### Added
- **Startup health check** ‚Äî `castor run` now performs a full system health check at boot: Python version, package version, dependencies, config validation, AI provider auth, camera, GPIO, I2C, speaker, disk space, memory, CPU temperature. Prints a formatted health card with ‚úÖ‚ö†Ô∏è‚ùå status.
- **Wizard state memory** ‚Äî wizard remembers previous selections (project name, provider, model) and shows them as defaults on re-run. Saved to `~/.opencastor/wizard-state.yaml`.
- **Dynamic version** ‚Äî `__version__` now reads from installed package metadata via `importlib.metadata` instead of a hardcoded string. Falls back to current version if not pip-installed.
- 21 new tests (1286 total)

### Fixed
- Wizard version display was stuck on old version due to hardcoded `__version__` in `__init__.py`

## [2026.2.18.3] - 2026-02-18

### Fixed
- Lint error: extraneous f-string prefix in cli.py (F541)

## [2026.2.18.2] - 2026-02-18

### Added
- **Dynamic model lists** ‚Äî Anthropic and OpenAI model selection now fetches live from their APIs, showing the 3 latest models with an option to expand the full list
- Falls back gracefully to built-in static list if API is unreachable or no key is available
- 6 new tests for dynamic model fetching (1271 total)

## [2026.2.18.1] - 2026-02-18

### Changed
- **Separate token store** ‚Äî OpenCastor now stores Anthropic tokens at `~/.opencastor/anthropic-token`, NOT in Claude CLI's credentials. Prevents the "token sink" problem where sharing tokens between OpenCastor/OpenClaw/Claude CLI causes mutual invalidation.
- **`castor login anthropic`** ‚Äî option [1] now runs `claude setup-token` directly to generate a fresh token for OpenCastor
- Wizard setup-token flow saves to `~/.opencastor/` instead of `.env`
- Token file has 0600 permissions for security
- 8 new tests (1265 total)

## [2026.2.17.21] - 2026-02-17

### Added
- **Anthropic setup-token auth** ‚Äî use your Claude Max/Pro subscription instead of pay-per-token API keys
- **`castor login anthropic`** (alias: `castor login claude`) ‚Äî interactive setup-token or API key auth
- **Auto-read Claude CLI credentials** ‚Äî reads setup-token from `~/.claude/.credentials.json` as fallback
- Wizard now recommends setup-token as option [1] over API key
- 7 new Anthropic auth tests (1264 total)

## [2026.2.17.20] - 2026-02-17

### Added
- **Wizard redesign** ‚Äî QuickStart now has distinct steps: Provider ‚Üí Auth ‚Üí Primary Model ‚Üí Secondary Models ‚Üí Messaging
- **Provider-specific auth flows** ‚Äî Anthropic (Max/Pro OAuth or API key), Google (ADC via `gcloud` or API key), HuggingFace (`huggingface-cli login` or paste token), OpenAI (API key), Ollama (connection check)
- **Primary model selection** ‚Äî curated model list per provider with recommendations and descriptions
- **Secondary models** ‚Äî optional specialized models (Gemini Robotics ER 1.5, GPT-4o vision, custom) with cross-provider auth
- **Uninstall script** ‚Äî `curl -sL opencastor.com/uninstall | bash`
- 21 new wizard tests (1244 total)

## [2026.2.17.17] - 2026-02-17

### Added
- **"Start your robot now?"** ‚Äî wizard offers to launch `castor run` immediately after setup completes

### Fixed
- **Post-install instructions** ‚Äî simplified Quick Start to `cd && source venv/bin/activate && castor run` (castor requires venv active)

## [2026.2.17.19] - 2026-02-17

### Added
- **Wizard redesign** ‚Äî QuickStart now has distinct steps: Provider ‚Üí Auth ‚Üí Primary Model ‚Üí Secondary Models ‚Üí Messaging
- **Provider-specific auth flows** ‚Äî Anthropic (Max/Pro OAuth or API key), Google (ADC via `gcloud` or API key), HuggingFace (`huggingface-cli login` or paste token), OpenAI (API key), Ollama (connection check)
- **Primary model selection** ‚Äî curated model list per provider with recommendations and descriptions
- **Secondary models** ‚Äî optional specialized models (Gemini Robotics ER 1.5, GPT-4o vision, custom) with cross-provider auth
- 21 new wizard tests (1244 total)

## [2026.2.17.18] - 2026-02-17

### Added
- **Claude Max/Pro plan support** ‚Äî wizard offers OAuth sign-in as option 1 when choosing Anthropic. Auto-detects Claude CLI, installs if needed, runs `claude login` for browser-based auth. Falls back to API key gracefully.
- **Uninstall script** ‚Äî `curl -sL opencastor.com/uninstall | bash`

## [2026.2.17.16] - 2026-02-17

### Added
- **QuickStart now includes provider + messaging choice** ‚Äî users pick their AI provider (Anthropic, Google, OpenAI, HuggingFace, Ollama) and optionally connect WhatsApp or Telegram, all in the streamlined QuickStart flow

### Fixed
- **RCAN schema** ‚Äî added `created_at` to metadata schema (was causing validation error)

## [2026.2.17.15] - 2026-02-17

### Fixed
- **Installer** ‚Äî wizard stdin redirected to `/dev/tty` for `curl | bash` piped installs (wizard reads user input properly instead of script lines)
- **Post-install messaging** ‚Äî clear "Useful Commands" section showing `castor wizard`, `castor --help`, `castor status`, `castor doctor`, `castor dashboard`; explicit tip that wizard can be re-run anytime

## [2026.2.17.14] - 2026-02-17

### Fixed
- **Installer** ‚Äî wizard runs with `--accept-risk` (skips safety prompt, goes straight to config), no longer swallows wizard output, properly reports exit code
- **Wizard version** ‚Äî now displays correct dynamic version via f-string

## [2026.2.17.13] - 2026-02-17

### Fixed
- **neonize version pin** ‚Äî `>=1.0.0` ‚Üí `>=0.3.10` (1.0 doesn't exist)
- **Installer resilience** ‚Äî `[rpi]` extras failure falls back to core install instead of aborting

## [2026.2.17.12] - 2026-02-17

### Fixed
- **Installer** ‚Äî `libatlas-base-dev` detection uses `apt-cache policy` (handles Bookworm "no candidate" correctly), `DEBIAN_FRONTEND=noninteractive` suppresses kernel upgrade dialogs, detached HEAD handled in `git pull`
- **`python -m castor`** ‚Äî Added `__main__.py` so the package is runnable as a module
- **Install verification** ‚Äî `install-check.sh` tries `castor` binary before `python -m castor` fallback

## [2026.2.17.11] - 2026-02-17

### Added
- **Cross-platform installer** ‚Äî `install.sh` supports macOS (Homebrew), Fedora (dnf), Arch (pacman), Alpine (apk) alongside Debian/Ubuntu/RPi. New `install.ps1` for native Windows PowerShell. Post-install verification scripts (`install-check.sh`, `install-check.ps1`). CI matrix testing on ubuntu/macos/windows.
- **Safety Protocol Engine** (`castor/safety/protocol.py`) ‚Äî 10 configurable rules adapted from Protocol 66, YAML config overrides, `castor safety rules` CLI
- **Continuous sensor monitoring** (`castor/safety/monitor.py`) ‚Äî CPU temp, memory, disk, CPU load with background thread, auto e-stop after 3 consecutive criticals, `/proc/sensors` in virtual FS, `castor monitor --watch` CLI
- **Ollama provider improvements** ‚Äî model cache with TTL, auto-pull, model aliases, remote host profiles via `OLLAMA_HOST`, configurable timeouts, helpful error messages

### Changed
- **BREAKING: RCAN role alignment** ‚Äî `ADMIN` ‚Üí `OWNER`, `OPERATOR` ‚Üí `LEASEE` per RCAN spec. Backward compatibility layer accepts old names with deprecation warning.
- **Cross-platform Python** ‚Äî platform markers on RPi deps (`; sys_platform == 'linux'`), `[core]`/`[all]` extras groups, conditional imports for hardware modules, cross-platform TTS/crontab/service commands

### Fixed
- **Installer** ‚Äî friendly skip for `libatlas-base-dev` on Bookworm/RPi5, default config fallback (`robot.rcan.yaml`) when wizard is skipped
- **Safety module polish** ‚Äî wrapped integration points in try/except, fixed CLI syntax error, cleaned imports, reformatted files
- **Website** ‚Äî shrunk oversized wizard-creates icons, fixed mobile nav hamburger menu cutoff

## [2026.2.17.10] - 2026-02-17

### Added
- **Anti-subversion module** (`castor/safety/anti_subversion.py`) ‚Äî prompt injection defense with 15 regex patterns, forbidden path detection, anomaly rate-spike flagging, wired into SafetyLayer and BaseProvider
- **Work authorization** (`castor/safety/authorization.py`) ‚Äî work order lifecycle for destructive actions (request ‚Üí approve ‚Üí execute/revoke), role-gated approval, self-approval prevention, auto-expiry, destructive action detection for GPIO/motor paths
- **Physical bounds enforcement** (`castor/safety/bounds.py`) ‚Äî workspace sphere/box/forbidden zones, per-joint position/velocity/torque limits, force limits (50N default, 10N human-proximity), pre-built configs for differential_drive/arm/arm_mobile
- **Tamper-evident audit log** ‚Äî SHA-256 hash chain on every audit entry, `castor audit --verify` CLI, backward-compatible with existing logs
- **Safety state telemetry** (`castor/safety/state.py`) ‚Äî `SafetyStateSnapshot` with composite health score exposed at `/proc/safety`
- **Recipe submission issue template** (`.github/ISSUE_TEMPLATE/recipe-submission.yml`)
- **`castor hub share --submit`** ‚Äî auto-fork, branch, and PR via `gh` CLI

### Fixed
- **RCAN Safety Invariants 4 & 5** ‚Äî `check_role_rate_limit()` and `check_session_timeout()` now enforced in all SafetyLayer public methods (read/write/append/ls/stat/mkdir)
- **E-stop authorization** ‚Äî `clear_estop()` requires auth code via `OPENCASTOR_ESTOP_AUTH` env var when set

### Changed
- **PyPI publishing** ‚Äî Trusted Publisher (OIDC) with API token fallback, all actions pinned to SHA, scoped permissions, concurrency groups, timeouts, twine check

## [2026.2.17.9] - 2026-02-17

### Added
- **Ollama provider** ‚Äî run local LLMs with zero API keys
  - Text generation and vision support (LLaVA, BakLLaVA, Moondream, etc.)
  - Streaming token output via `/api/chat`
  - Model listing and pulling via Ollama API
  - `castor login ollama` ‚Äî test connection, configure host, list available models
  - Proper `OllamaConnectionError` with helpful "ollama serve" message
  - Auto-detection of vision-capable models

## [2026.2.17.8] - 2026-02-17

### Added
- **Community Hub** ‚Äî browse, share, and install tested robot configs
  - `castor hub browse` ‚Äî list recipes with category/difficulty/provider filters
  - `castor hub search` ‚Äî full-text search across all recipes
  - `castor hub show` ‚Äî view recipe details and README
  - `castor hub install` ‚Äî copy a recipe config to your project
  - `castor hub share` ‚Äî interactive wizard to package and scrub your config
  - `castor hub categories` ‚Äî list all categories and difficulty levels
- **PII scrubbing engine** ‚Äî automatically removes API keys, emails, phone numbers, public IPs, home paths, and secrets from shared configs
- **2 seed recipes** ‚Äî PiCar-X Home Patrol (beginner/home) and Farm Scout Crop Inspector (intermediate/agriculture)
- **Hub website page** at opencastor.com/hub with category browser and recipe cards
- Hub link added to site navigation across all pages
- 17 new tests for hub (PII scrubbing, packaging, listing, filtering)

## [2026.2.17.7] - 2026-02-17

### Added
- **Hugging Face provider** ‚Äî access 1M+ models via the Inference API
  - Text-generation and vision-language models (LLaVA, Qwen-VL, etc.)
  - Supports Inference Endpoints for dedicated deployments
  - Auto-detects vision-capable models
- **`castor login` CLI command** ‚Äî authenticate with Hugging Face
  - Interactive token prompt with secure input
  - `--list-models` flag to discover trending models by task
  - Saves token to both `~/.cache/huggingface/` and local `.env`
- `huggingface-hub` added as core dependency
- Hugging Face option added to setup wizard (option 5)
- 10 new tests for HF provider and login CLI

### Changed
- Provider count: 4 ‚Üí 5 (website, docs, stats updated)
- Ollama moved from wizard option 5 ‚Üí 6

## [2026.2.17.6] - 2026-02-17

### Fixed
- Removed deprecated `License :: OSI Approved` classifier (PEP 639 compliance) ‚Äî newer setuptools rejected it when `license` expression was already set
- Ran `ruff format` across all 73 source and test files to pass CI formatting check
- Added `python-multipart>=0.0.7` as explicit dependency ‚Äî required by FastAPI for `request.form()`, was failing on Python 3.10/3.11 in CI
- Replaced invalid PyPI classifier `Topic :: Scientific/Engineering :: Robotics` with valid `Artificial Intelligence` classifier
- Synced package version in `pyproject.toml` with git tag

## [2026.2.17.5] - 2026-02-17

### Added
- `py.typed` marker for PEP 561 type hint support
- `__all__` exports to core modules (providers, drivers, channels, root)
- Return type annotations (`-> None`) on all 41 CLI command handlers
- Type hints and docstrings on `DriverBase` abstract methods (move, stop, close)
- Signal handling (SIGTERM/SIGINT) in API gateway for graceful shutdown
- CLI commands reference table in CONTRIBUTING.md
- Comprehensive test suites: CLI, API endpoints, drivers, channels
- Dependabot config for Python dependencies (already existed for GitHub Actions)

### Fixed
- `castor schedule` command not dispatching due to `--command` arg shadowing subparser `dest="command"`

### Changed
- `DriverBase.move()` now has explicit `linear: float, angular: float` signature
- CONTRIBUTING.md now documents all 41 CLI commands and how to add new ones
- API gateway version updated to 2026.2.17.5

## [2026.2.17.4] - 2026-02-17

### Added
- 41-command CLI with grouped help (`castor --help`)
- `castor doctor` -- system health checks
- `castor fix` -- auto-repair common issues with backup-before-repair
- `castor demo` -- simulated perception-action loop (no hardware/API keys)
- `castor quickstart` -- one-command setup (wizard + demo)
- `castor configure` -- interactive post-wizard config editor
- `castor shell` / `castor repl` -- interactive command shells
- `castor record` / `castor replay` -- session recording and playback
- `castor benchmark` -- perception-action loop performance profiling
- `castor lint` -- deep config validation beyond JSON schema
- `castor learn` -- interactive 7-lesson tutorial
- `castor test` -- pytest wrapper for running test suite
- `castor diff` -- structured RCAN config comparison
- `castor profile` -- named config profile management
- `castor plugins` -- extensible plugin hook system (`~/.opencastor/plugins/`)
- `castor audit` -- append-only event audit log viewer
- `castor approvals` -- approval queue for dangerous motor commands
- `castor schedule` -- cron-like task scheduling
- `castor search` -- semantic search over operational logs
- `castor network` -- Tailscale integration and network status
- `castor fleet` -- multi-robot fleet management via mDNS
- `castor export` -- config bundle export with secrets auto-redacted
- `castor watch` -- live Rich telemetry dashboard
- `castor logs` -- structured colored log viewer with filtering
- `castor backup` / `castor restore` -- config and credential backup
- `castor migrate` -- RCAN config version migration
- `castor upgrade` -- self-update with health check
- `castor update-check` -- PyPI version check with cache
- `castor install-service` -- systemd service unit generation
- `castor privacy` -- sensor access privacy policy viewer
- `castor calibrate` -- interactive servo/motor calibration
- `castor test-hardware` -- individual motor/servo testing
- Safety: watchdog timer (auto-stop on brain timeout)
- Safety: geofence (operating radius limit with dead reckoning)
- Safety: approval gate (queue dangerous commands for human review)
- Safety: privacy policy (default-deny for camera, audio, location)
- Safety: battery monitor with low-voltage emergency stop
- Safety: crash recovery with automatic crash reports
- Contextual error messages with fix suggestions
- Plugin system with startup/shutdown/action/error hooks
- Shell completions via argcomplete
- SECURITY.md with vulnerability disclosure policy
- CHANGELOG.md
- pytest-cov integration for code coverage
- Pre-commit hooks (ruff, ruff-format, secrets scanning)

### Fixed
- CI workflows: `actions/checkout@v6` -> `@v4`, `actions/setup-python@v6` -> `@v5`
- Dockerfile: added non-root user, updated to `bookworm` base
- docker-compose: added `depends_on`, log rotation limits
- Moved `argcomplete` from dev to core dependencies

### Changed
- README updated with all 41 CLI commands (was 6)
- Architecture diagram now includes API gateway layer
- Ruff rules expanded: added bugbear (B), bandit security (S), pyupgrade (UP)
- CORS in api.py now configurable via `OPENCASTOR_CORS_ORIGINS` env var
- PyPI classifiers updated (License, OS, Environment, Robotics topic)

## [2026.2.17.3] - 2026-02-17

### Added
- Initial public release
- Provider adapters: Google Gemini, OpenAI GPT-4.1, Anthropic Claude
- Hardware drivers: PCA9685 (I2C PWM), Dynamixel (Protocol 2.0)
- Messaging channels: WhatsApp (neonize), Telegram, Discord, Slack
- FastAPI gateway with REST API and webhook endpoints
- Streamlit dashboard (CastorDash)
- RCAN Standard compliance with JSON Schema validation
- Virtual filesystem with RBAC and safety layers
- RCAN Protocol: JWT auth, mDNS discovery, message routing, capability registry
- Interactive setup wizard
- Docker and docker-compose support
- One-line installer script for Raspberry Pi
- Cloudflare Pages static site
