# Release workflow for OpenCastor
#
# Triggers on version tags (v*). Runs tests, creates a GitHub Release,
# and publishes to PyPI using Trusted Publishing (OIDC).
#
# PyPI Trusted Publisher Setup:
#   1. Go to https://pypi.org/manage/project/opencastor/settings/publishing/
#   2. Add a new GitHub publisher:
#      - Owner: craigm26
#      - Repository: OpenCastor
#      - Workflow name: release.yml
#      - Environment name: release
#   3. Save. No API token needed after this.
#
# The publish job tries OIDC first, then falls back to PYPI_API_TOKEN secret.

name: Release

on:
  push:
    tags:
      - 'v*'

# Cancel in-progress runs for the same tag
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    name: "Test"
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.10'
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Lint
        run: ruff check castor/

      - name: Validate RCAN configs
        run: |
          pip install jsonschema pyyaml
          python3 .github/scripts/validate_rcan.py \
            --schema config/rcan.schema.json \
            --dir .

      - name: Run tests
        run: pytest tests/ -q

  release:
    needs: test
    runs-on: ubuntu-latest
    name: "Create Release"
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.10'
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Sync version across all touchpoints
        run: |
          python scripts/sync-version.py ${{ steps.version.outputs.VERSION }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet || git commit -am "chore: sync version touchpoints to v${{ steps.version.outputs.VERSION }} [skip ci]"
          git push origin HEAD:main || true

      - name: Generate release notes
        id: notes
        run: |
          # Get commits since last tag (or all if first release)
          PREV_TAG=$(git tag --sort=-creatordate | head -2 | tail -1 || echo "")
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${GITHUB_REF#refs/tags/}" ]; then
            COMMITS=$(git log --oneline --no-decorate)
          else
            COMMITS=$(git log --oneline --no-decorate "${PREV_TAG}..HEAD")
          fi
          echo "COMMITS<<EOF" >> "$GITHUB_OUTPUT"
          echo "$COMMITS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          name: "OpenCastor v${{ steps.version.outputs.VERSION }}"
          body: |
            ## OpenCastor v${{ steps.version.outputs.VERSION }}

            ### Commits
            ```
            ${{ steps.notes.outputs.COMMITS }}
            ```

            ### Install
            ```bash
            curl -sL opencastor.com/install | bash
            ```

            Or with pip:
            ```bash
            pip install opencastor==${{ steps.version.outputs.VERSION }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    needs: release
    runs-on: ubuntu-latest
    name: "Publish to PyPI (OIDC)"
    timeout-minutes: 10
    environment: release
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.10'
          cache: pip

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Verify package
        run: |
          pip install twine
          twine check dist/*

      - name: Publish to PyPI (Trusted Publisher / OIDC)
        id: publish-oidc
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # v1.12.4
        continue-on-error: true
        with:
          skip-existing: true

      - name: Publish to PyPI (API token fallback)
        if: steps.publish-oidc.outcome == 'failure'
        uses: pypa/gh-action-pypi-publish@76f52bc884231f62b9a034ebfe128415bbaabdfc # v1.12.4
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
